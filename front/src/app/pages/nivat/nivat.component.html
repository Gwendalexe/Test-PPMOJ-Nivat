<app-navbar></app-navbar>

<div class="game-container container-fluid flex-column align-items-center flex-grow-1">
  <div class="content-wrapper">
    <div *ngIf="hasBeenSolved && isVictoryPopupOpen" class="victory-overlay" (click)="closeVictoryPopup()">
      <div class="card primary-card victory-card" (click)="$event.stopPropagation()">
        <button class="btn-close-popup" (click)="closeVictoryPopup()" aria-label="Fermer">
          <i class="bi bi-x-lg"></i>
        </button>

        <h2 *ngIf="gridId" class="text-center">Félicitations !</h2>

        <div *ngIf="gridId" class="d-flex flex-column text-center my-3">
          <span>
            Vous avez résolu la grille en <strong>{{ displayTime }}</strong> et
            <strong>{{ finalMoveCount }}</strong> coups !
          </span>
          <span class="mt-2">
            Vous avez remporté <b>{{ reward }}</b> mojettes !
          </span>
        </div>

        <div class="btn-container d-flex justify-content-center">
          <button (click)="router.navigate(['/'])" class="btn btn-secondary btn-sm">Retour à l'accueil</button>
        </div>
      </div>
    </div>

    <div id="nivat-matrix-container" class="container card primary-card">
      <button class="btn btn-help" (click)="isHelpOpen = !isHelpOpen" aria-label="Règles du jeu">?</button>

      <div class="nivat-matrix-header">
        <button (click)="toggleTimer()" class="btn btn-timer btn-primary btn-sm justify-self-start">
          {{ hasStarted ? 'Reset' : 'Start' }}
        </button>

        <span class="timer justify-self-center">{{ displayTime }}</span>

        <span class="counter justify-self-end" style="font-weight: bold"> {{ currentMoveCount }} coups </span>
      </div>

      <app-nivat-grid
        [grid]="grid"
        [isLocked]="hasBeenSolved"
        (newMoveEvent)="newMoveEventHandler($event)"
        (isSolvedEvent)="isSolved($event)"
        (interactionWhenLocked)="proposeRestart()">
      </app-nivat-grid>
    </div>

    <div class="control-panel">
      <div class="control-row">
        <span class="label-text">Difficulté :</span>

        <div class="custom-dropdown">
          <button class="dropdown-trigger" (click)="toggleMenu()">
            {{ getLevelLabel() }}
            <span class="arrow" [class.open]="isMenuOpen">▼</span>
          </button>

          <div class="dropdown-options" *ngIf="isMenuOpen">
            <button class="option" (click)="selectLevel('1')" [class.active]="selectedLevel === '1'">Facile</button>
            <button class="option" (click)="selectLevel('2')" [class.active]="selectedLevel === '2'">Moyen</button>
            <button class="option" (click)="selectLevel('3')" [class.active]="selectedLevel === '3'">Difficile</button>
          </div>
        </div>
      </div>

      <a class="secondary-link" (click)="goToGridBrowse()"> En difficulté ? Jouez une autre grille </a>
    </div>
  </div>
</div>
<div *ngIf="isHelpOpen" id="modal-backdrop" (click)="isHelpOpen = false"></div>

<dialog id="helpDialog" class="d-flex modal card primary-modal" [ngClass]="{ open: isHelpOpen }">
  <div class="dialog-content">
    <h3>Comment jouer ?</h3>
    <p>Le but est d'amener toutes les sommes (lignes et colonnes) à <strong>0</strong>.</p>
    <p>Utilisez les flèches pour décaler les rangées.</p>
  </div>
  <span class="justify-content-end swipe-info align-center mt-auto">
    Swipe up pour fermer <i class="bi bi-arrow-up-short"></i>
  </span>
</dialog>
