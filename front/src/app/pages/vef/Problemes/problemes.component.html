<div *ngIf="problemNotExists" class="pbMessage">
  <h1>Ce problème n'existe pas</h1>
</div>

<div
  *ngIf="hasLoadedData && !problemNotExists && !hasBeenSolved"
  class="problem-container container-fluid d-flex flex-row justify-content-center align-items-stretch">
  <div class="enigme-card card primary-card">
    <div
      class="infos-container card-header d-flex flex-row justify-content-between">
      <div class="container d-flex justify-content-start">
        <span>{{ titreType.substring(0, 4) }}. - {{ enigmeLevel }}</span>
      </div>
      <div class="container d-flex justify-content-end">
        <span>{{ currentProblem.reward }} </span>
        <img
          class="svg-img"
          src="../../../assets/beans.svg"
          alt="Mojette SVG" />
      </div>
      <!-- <p>Titre du problème</p> -->
    </div>
    <span class="consigne"><i>Enoncé : </i>{{ currentProblem.statement }}</span>

    <div class="image-container">
      <img
        [src]="
          currentProblem.figure_path
            ? '../../../assets/enigmes/' + currentProblem.figure_path
            : null
        "
        alt="Image de l'énigme"
        class="image-clickable"
        (click)="openImageModal(currentProblem.figure_path ? '../../../assets/enigmes/' + currentProblem.figure_path : '')" />
    </div>
  </div>

  <div class="solution-form-card card primary-card">
    <div
      class="title-container d-flex justify-content-between align-items-center">
      <span class="question d-block">
        <i>Problème : </i>
        {{ questionString }}
      </span>
    </div>

    <div class="card-help-container d-flex flex-column">
      <button
        class="btn btn-text square align-self-center"
        *ngIf="currentProblem"
        (click)="askHint()"
        [ngClass]="{
          disabled: helpsUsed === currentProblem.nb_help,
        }"
        [disabled]="
          currentProblem.help_cost[helpsUsed] > currentUser['mojettes']!
        ">
        <span>
          Aide
          <small>
            - {{ currentProblem.help_cost[helpsUsed] }}
            <img
              class="svg-img"
              src="../../../assets/beans.svg"
              alt="Mojette SVG" />
          </small>
        </span>
      </button>
      <div
        *ngIf="unlockedHelps.length !== 0"
        class="help-container d-flex flex-column">
        <ng-container *ngFor="let help of unlockedHelps; let i = index">
          <span class="help-text"
            ><i>Aide {{ i + 1 }} : </i>{{ help }}</span
          >
        </ng-container>
      </div>
    </div>

    <div class="card-content-container d-flex flex-column">
      <div class="form-container">
        <form [formGroup]="form" id="formProblem" (ngSubmit)="submitForm()">
          <ng-container *ngIf="variables.length === 0">
            <ng-container
              *ngFor="
                let questionIndex of [].constructor(
                  currentProblem?.nb_question
                );
                let i = index
              ">
              <label
                *ngIf="currentProblem.question![i]"
                class="question-label"
                htmlFor="value-{{ i }}-input"
                >{{ capitalizeFirstLetter(currentProblem.question![i]) }}</label
              >
              <div
                class="d-flex flex-row justify-content-between form-input-row-questions">
                <ng-container
                  *ngFor="
                    let val of counterArray(nbValToFind || 0);
                    let j = index
                  ">
                  <!-- <input formControlName="value{{ j }}" placeholder="Valeur {{ j + 1 }}" type="tel"
                        pattern="[0-9]*">         -->
                  <mat-form-field
                    class="problem-form-field"
                    appearance="outline">
                    <input
                      matInput
                      formControlName="group{{ i }}_value{{ j }}"
                      placeholder="Valeur {{ i + 1 }}"
                      name="value-{{ i }}-input"
                      id="value-{{ i }}-input"
                      pattern="[0-9]+" />
                  </mat-form-field>
                </ng-container>
              </div>
            </ng-container>
            <mat-error *ngIf="badAnswer" class="response-error"
              >Réponse incorrecte.</mat-error
            >
            <mat-error *ngIf="form.errors?.['required']" class="response-error"
              >Veuillez remplir tout les champs.</mat-error
            >
            <mat-error *ngIf="form.errors?.['pattern']" class="response-error"
              >Veuillez rentrer des nombres valides.</mat-error
            >
          </ng-container>

          <ng-container *ngIf="variables.length !== 0">
            <ng-container *ngFor="let i of indicesAVerifier; let index = index">
              <label class="question-label" htmlFor="value-{{ i }}-input"
                >Pour
                <ng-container
                  *ngFor="
                    let variable of variables;
                    let j = index;
                    let isLast = last
                  ">
                  <b>{{ variable }} = {{ valuesToFind[i][j] }}</b>
                  <ng-container *ngIf="!isLast"> et </ng-container>
                </ng-container>
              </label>
              <div
                class="d-flex flex-row justify-content-between form-input-row">
                <ng-container *ngFor="let j of counterArray(nbValToFind || 0)">
                  <!-- <input formControlName="value{{ j }}" placeholder="Valeur {{ j + 1 }}" type="tel" pattern="[0-9]*" (input)="validateNumber($event)"> -->
                  <mat-form-field
                    class="problem-form-field"
                    appearance="outline">
                    <input
                      matInput
                      formControlName="group{{ index }}_value{{ j }}"
                      placeholder="Valeur"
                      name="value-{{ i }}-input"
                      id="value-{{ i }}-input"
                      pattern="[0-9]+"
                      required="true" />
                  </mat-form-field>
                </ng-container>
              </div>
            </ng-container>
            <mat-error *ngIf="badAnswer" class="response-error"
              >Réponse incorrecte.</mat-error
            >
            <mat-error *ngIf="form.errors?.['required']" class="response-error"
              >Veuillez remplir tout les champs.</mat-error
            >
            <mat-error *ngIf="form.errors?.['pattern']" class="response-error"
              >Veuillez rentrer des nombres valides.</mat-error
            >
          </ng-container>
        </form>
      </div>
    </div>

    <div class="button-container d-flex justify-content-center">
      <button class="btn btn-primary btn-sm" form="formProblem" type="submit">
        Répondre
      </button>
      <button class="btn btn-secondary btn-sm" (click)="goToTDFHome()">
        Retour
      </button>
    </div>
  </div>
</div>

<div
  *ngIf="hasLoadedData && !problemNotExists && hasBeenSolved"
  class="container-fluid d-flex flex-column justify-content-center position-relative flex-grow-1">
  <div id="endDialog" class="card primary-card">
    <h2 class="text-center">Félicitations !</h2>
    <div class="d-flex flex-column">
      <span>Vous avez résolu cette énigme !</span>
      <span>Vous avez remporté {{ reward }} mojettes !</span>
    </div>
    <div class="btn-container d-flex flex-row justify-content-between">
      <button (click)="goToTDFHome()" class="btn btn-primary btn-sm">
        Nouveau Probleme
      </button>
      <button (click)="goToHomePage()" class="btn btn-secondary btn-sm">
        Retour à l'accueil
      </button>
    </div>
  </div>
</div>

<div
  *ngIf="isImageModalOpen"
  class="image-lightbox"
  role="dialog"
  aria-label="Agrandir l'image de l'énigme"
  (click)="closeImageModal()">
  <img
    [src]="modalImageSrc"
    class="image-lightbox__img"
    [class.is-zoomed]="isImageZoomed"
    alt="Image de l'énigme agrandie"
    (click)="toggleImageZoom($event)" />
  <button
    type="button"
    class="image-lightbox__close"
    aria-label="Fermer l'aperçu"
    (click)="closeImageModal(); $event.stopPropagation(); $event.preventDefault()">
    X
  </button>
</div>
